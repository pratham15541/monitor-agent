name: agent-release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    build:
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: ubuntu-latest
                      goos: linux
                      goarch: amd64
                      ext: ""
                    - os: ubuntu-latest
                      goos: linux
                      goarch: arm64
                      ext: ""
                    - os: macos-latest
                      goos: darwin
                      goarch: amd64
                      ext: ""
                    - os: macos-latest
                      goos: darwin
                      goarch: arm64
                      ext: ""
                    - os: windows-latest
                      goos: windows
                      goarch: amd64
                      ext: ".exe"

        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.24.x"

            - name: Build (unix)
              if: runner.os != 'Windows'
              working-directory: monitor-agent
              run: |
                  VERSION=${GITHUB_REF_NAME#v}
                  mkdir -p ../dist
                  CGO_ENABLED=0 GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -ldflags "-X monitor-agent/cmd.Version=$VERSION" -o ../dist/monitor-agent-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }} .

            - name: Build (windows)
              if: runner.os == 'Windows'
              working-directory: monitor-agent
              shell: pwsh
              run: |
                  $version = "${{ github.ref_name }}".TrimStart("v")
                  New-Item -ItemType Directory -Force -Path ..\dist | Out-Null
                  $env:CGO_ENABLED = "0"
                  $env:GOOS = "${{ matrix.goos }}"
                  $env:GOARCH = "${{ matrix.goarch }}"
                  go build -ldflags "-X monitor-agent/cmd.Version=$version" -o ..\dist\monitor-agent-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }} .

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: monitor-agent-${{ matrix.goos }}-${{ matrix.goarch }}
                  path: dist/monitor-agent-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }}

    release:
        runs-on: ubuntu-latest
        needs: build

        steps:
            - name: Download artifacts
              uses: actions/download-artifact@v4
              with:
                  path: dist
                  merge-multiple: true

            - name: Generate checksums
              run: |
                  cd dist
                  sha256sum * > checksums.txt

            - name: Create release
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      dist/*
                  generate_release_notes: true
